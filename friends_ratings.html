<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friends' Ratings</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: auto;
            text-align: center;
        }
        .rating-container {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: left;
        }
        .username-header {
            font-size: 18px;
            font-weight: bold;
            margin-top: 15px;
            text-align: left;
        }
        .friend-container {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h2>Friends' Beer Ratings</h2>
    <button onclick="window.location.href='index.html'">Back to Home</button>
    
    <div id="friendsRatingsList"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBfWCzRe_nIxoDNq2pe_tC208jNDNCp7BU",
            authDomain: "beerdex-87d10.firebaseapp.com",
            databaseURL: "https://beerdex-87d10-default-rtdb.firebaseio.com/",
            projectId: "beerdex-87d10",
            storageBucket: "beerdex-87d10.appspot.com",
            messagingSenderId: "1056856047818",
            appId: "1:1056856047818:web:ac019e2e037bf15509b433"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        function loadFriendsRatings() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please log in to see friends' ratings.");
                window.location.href = "index.html";
                return;
            }

            const friendsRatingsList = document.getElementById("friendsRatingsList");
            friendsRatingsList.innerHTML = "";

            // Get the list of friends
            database.ref("users/" + user.uid + "/friends").once("value", snapshot => {
                if (!snapshot.exists()) {
                    friendsRatingsList.innerHTML = "<p>You have no friends added yet.</p>";
                    return;
                }

                snapshot.forEach(friendSnapshot => {
                    const friendId = friendSnapshot.key; // FIX: Get the key as the friend's UID

                    if (!friendId || typeof friendId !== "string") {
                        console.error(`Invalid friend ID: ${friendId}`);
                        return;
                    }

                    database.ref("users/" + friendId).once("value").then(friendUserSnap => {
                        const friendData = friendUserSnap.val();
                        if (!friendData) {
                            console.error(`No data found for friend ID: ${friendId}`);
                            return;
                        }

                        const friendUsername = friendData.username ? friendData.username : friendData.email ? friendData.email : "Unknown";

                        // Create a container for each friend
                        const friendContainer = document.createElement("div");
                        friendContainer.className = "friend-container";

                        // Add friend's username before their ratings
                        const friendHeader = document.createElement("div");
                        friendHeader.className = "username-header";
                        friendHeader.innerText = friendUsername;
                        friendContainer.appendChild(friendHeader);

                        // Fetch their ratings
                        database.ref("users/" + friendId + "/ratings").once("value", ratingsSnapshot => {
                            if (!ratingsSnapshot.exists()) {
                                const noRatings = document.createElement("p");
                                noRatings.innerText = "No ratings available.";
                                friendContainer.appendChild(noRatings);
                            } else {
                                ratingsSnapshot.forEach(ratingSnap => {
                                    const rating = ratingSnap.val();
                                    const ratingDiv = document.createElement("div");
                                    ratingDiv.className = "rating-container";
                                    ratingDiv.innerHTML = `
                                        <p><strong>${rating.beerName}</strong> - ${rating.rating}/5</p>
                                        <p><strong>Location:</strong> ${rating.location}</p>
                                        <p><strong>Occasion:</strong> ${rating.occasion}</p>
                                        <p><strong>Comments:</strong> ${rating.comments}</p>
                                    `;
                                    friendContainer.appendChild(ratingDiv);
                                });
                            }
                            // Append each friend's ratings under their name
                            friendsRatingsList.appendChild(friendContainer);
                        });
                    });
                });
            });
        }

        auth.onAuthStateChanged(user => {
            if (user) loadFriendsRatings();
        });
    </script>
</body>
</html>
