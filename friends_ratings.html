<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friends' Ratings</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: auto;
            text-align: center;
        }
    </style>
</head>
<body>
    <h2>Friends' Ratings</h2>

    <div id="friendsRatingsList"></div>

    <button onclick="window.location.href='index.html'">Back to Home</button>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // Firebase initialization
        const firebaseConfig = { 
            apiKey: "AIzaSyBfWCzRe_nIxoDNq2pe_tC208jNDNCp7BU",
            authDomain: "beerdex-87d10.firebaseapp.com",
            databaseURL: "https://beerdex-87d10-default-rtdb.firebaseio.com/",  // Correct Firebase Realtime Database URL
            projectId: "beerdex-87d10",
            storageBucket: "beerdex-87d10.appspot.com",
            messagingSenderId: "1056856047818",
            appId: "1:1056856047818:web:ac019e2e037bf15509b433"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Wait for the Firebase Auth state to load
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                // Once authenticated, load friends' ratings
                loadFriendsRatings();
            } else {
                // If no user is signed in, show an error message
                alert("Please sign in to view your friends' ratings.");
            }
        });

        function loadFriendsRatings() {
            const user = auth.currentUser;
            if (user) {
                // Get the list of friends' IDs
                firebase.database().ref("users/" + user.uid + "/friends").once("value", snapshot => {
                    const friends = snapshot.val();
                    if (friends) {
                        const friendsIds = Object.keys(friends); // Get the friend IDs
                        const ratingPromises = friendsIds.map(friendId => {
                            return new Promise((resolve, reject) => {
                                // Fetch the friend's email and ratings
                                firebase.database().ref("users/" + friendId).once("value", friendSnapshot => {
                                    const friendEmail = friendSnapshot.val().email; // Get the friend's email
                                    
                                    firebase.database().ref("users/" + friendId + "/ratings").once("value", snapshot => {
                                        const ratings = [];
                                        snapshot.forEach(childSnapshot => {
                                            ratings.push({
                                                userId: friendId,
                                                ratingId: childSnapshot.key,
                                                ...childSnapshot.val()
                                            });
                                        });
                                        resolve({ email: friendEmail, ratings: ratings }); // Resolve both email and ratings
                                    }, reject); // Reject if there's an error fetching ratings
                                }, reject); // Reject if there's an error fetching friend data
                            });
                        });

                        // Wait for all rating promises to resolve
                        Promise.all(ratingPromises).then(allRatings => {
                            displayRatings(allRatings);
                        }).catch(error => {
                            console.error("Error fetching ratings:", error);
                            alert("There was an error loading the ratings.");
                        });
                    } else {
                        alert("You have no friends to display ratings for.");
                    }
                });
            } else {
                alert("Please sign in to view your friends' ratings.");
            }
        }

        function displayRatings(friendsData) {
            const ratingsList = document.getElementById("friendsRatingsList");
            ratingsList.innerHTML = ""; // Clear previous list

            if (friendsData.length === 0) {
                ratingsList.innerHTML = "<p>No ratings available.</p>";
            } else {
                friendsData.forEach(friendData => {
                    const div = document.createElement("div");
                    div.className = "rating-container";
                    
                    // Add the friend's email before displaying the ratings
                    div.innerHTML = `
                        <h3>${friendData.username}'s Ratings:</h3>
                        ${friendData.ratings.map(r => `
                            <div>
                                <p><strong>Beer Name:</strong> ${r.beerName}</p>
                                <p><strong>Location:</strong> ${r.location}</p>
                                <p><strong>Occasion:</strong> ${r.occasion}</p>
                                <p><strong>Comments:</strong> ${r.comments}</p>
                                <p><strong>Rating:</strong> ${r.rating}</p>
                            </div>
                        `).join("")}
                    `;
                    ratingsList.appendChild(div);
                });
            }
        }
    </script>
</body>
</html>
